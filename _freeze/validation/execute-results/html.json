{
  "hash": "309a4db2f2b052ac9ddc87cec2cf4466",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Validation cohort\"\ndate: \"2025-09-25\"     # ISO format; quoted\ndate-format: \"D MMMM YYYY\"  # optional: 25 September 2025\nformat: \n  html:\n    code-fold: true\n    number-sections: false\nexecute:\n  echo: true\n  warning: false\n  freeze: true         # (you can keep this on after you refresh the cache)\nbibliography: references.bib\ncsl: nature.csl\n---\n\nDescriptive analysis of cumulative incidence of censoring, hospital discharge, CRE infection or death. A competing risk (Fine-Gray) model was fitted to outcome of death, hospital discharge, or CRE infection censored to day 180. The cumulative incidence of competing risks are shown in [@fig-compete].\n\n::: {#fig-compete}\n\n::: {.cell}\n\n```{.r .cell-code}\n# -------------------------------------------------\n# 1. Unadjusted Fine–Gray (CRE infection as event)\n# -------------------------------------------------\nlibrary(prodlim)\nlibrary(riskRegression)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary (here)\n\n\nlibrary(here)\n\n# Load the exported dataset\ndata_extract <- read.csv(here(\"data\", \"data_extract.csv\"), stringsAsFactors = FALSE)\n\n# Quick check\n\nset.seed(123)   # for reproducibility\n\n# ----------------------------\n# 1. Prepare data\n# ----------------------------\ndf_model <- data.frame(\n  time_c = as.numeric(data_extract$time_c),\n  outcome_comp = as.integer(data_extract$outcome_comp)\n) %>%\n  filter(!is.na(time_c) & time_c >= 0)\n\n# ----------------------------\n# 2. Base CIF fit\n# ----------------------------\nci_fit <- prodlim(Hist(time_c, outcome_comp) ~ 1, data = df_model)\n\n# ----------------------------\n# 3. Times to evaluate\n# ----------------------------\ntimes_seq <- seq(0, 180, by = 5)\n\n# ----------------------------\n# 4. Bootstrap CIF estimates\n# ----------------------------\nB <- 200   # number of bootstrap resamples (increase to 1000 for publication)\n\nboot_cif <- function(data, times, cause) {\n  fit <- prodlim(Hist(time_c, outcome_comp) ~ 1, data = data)\n  predict(fit, cause = cause, times = times)\n}\n\nboot_results <- lapply(1:3, function(cause) {\n  mat <- replicate(B, {\n    idx <- sample(nrow(df_model), replace = TRUE)\n    boot_data <- df_model[idx, ]\n    boot_cif(boot_data, times_seq, cause)\n  })\n  # mean and CI across bootstrap runs\n  est <- predict(ci_fit, cause = cause, times = times_seq)\n  lower <- apply(mat, 1, quantile, 0.025, na.rm = TRUE)\n  upper <- apply(mat, 1, quantile, 0.975, na.rm = TRUE)\n  data.frame(times = times_seq, CIF = est, lower = lower, upper = upper,\n             cause = factor(cause))\n})\n\nci_tidy <- bind_rows(boot_results) %>%\n  mutate(cause = recode(cause,\n                        \"1\" = \"CRE infection\",\n                        \"2\" = \"Discharge\",\n                        \"3\" = \"Death\"))\n\n# ----------------------------\n# 5. NEJM-style plot\n# ----------------------------\nnejm_colors <- c(\"CRE infection\" = \"#D81B60\",\n                 \"Discharge\"     = \"#1E88E5\",\n                 \"Death\"         = \"black\")\n\np_nejm <- ggplot(ci_tidy, aes(x = times, y = CIF, color = cause, fill = cause)) +\n  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.15, color = NA) +\n  geom_line(size = 1.2) +\n  labs(x = \"Days since OLT\",\n       y = \"Cumulative incidence\",\n       color = NULL, fill = NULL) +\n  scale_color_manual(values = nejm_colors) +\n  scale_fill_manual(values = nejm_colors) +\n  theme_bw(base_size = 14) +\n  theme(\n    panel.grid = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    legend.text = element_text(size = 12),\n    axis.title = element_text(size = 14, face = \"bold\"),\n    axis.text = element_text(size = 12),\n    axis.ticks.length = unit(0.2, \"cm\")\n  )\n\nprint(p_nejm)\n```\n\n::: {.cell-output-display}\n![](validation_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nCumulative risk of competing outcomes in combined retrospective and prospective study cohorts\n:::\n\nA competing risk multivariate, Fine-gray model for day+180 CRE infection was then fitted using the original CRECOOLT covariate from the score:\n\n-   Surgical re intervention after OLT\n\n-   Need for mechanical ventilation\n\n-   Acute renal failure after transplant\n\n-   CRE colonization prior to OLT\n\n-   CRE colonization after OLT\n\n-   KPC-carbapenemase producing organism\n\n::: callout-note\n## Clarification from previous analysis\n\nIn this initial analysis I have not yet created a new variable limiting CRE colonization to within 60 days pretransplant.\n:::\n\nPredicted cumulative incidence of CRE infection versus the observed for the total (retrospective plus prospective cohort) is shown in [@fig-calibration1].\n\n::: {#fig-calibration1}\n\n::: {.cell}\n\n```{.r .cell-code}\n#############################################\n## Multivariable Fine–Gray + Calibration Plot\n## with Jittered Dots + Legend for Outcomes\n#############################################\n\nlibrary(dplyr)\nlibrary(cmprsk)\nlibrary(riskRegression)\nlibrary(prodlim)\nlibrary(ggplot2)\n\n# ============================================================\n# 1. Prepare dataset with covariates\n# ============================================================\ndf_model <- data_extract %>%\n  mutate(\n    post_olt_compli1 = ifelse(post_olt_compli___1 == 1, 1, 0),\n    post_olt_compli3 = ifelse(post_olt_compli___3 == 1, 1, 0),\n    post_olt_compli5 = ifelse(post_olt_compli___5 == 1, 1, 0),\n    multisite_col    = ifelse(multisite_colonization == 1, 1, 0),\n    cre_col1         = ifelse(cre_colonization___1 == 1, 1, 0),\n    cre_col2         = ifelse(cre_colonization___2 == 1, 1, 0)\n  ) %>%\n  select(time_c, outcome_comp,\n         post_olt_compli1, post_olt_compli3, post_olt_compli5,\n         multisite_col, cre_col1, cre_col2) %>%\n  filter(!is.na(time_c) & time_c >= 0)\n\n# ============================================================\n# 2. Fit Fine–Gray model (cause = CRE infection)\n# ============================================================\nfg_risk <- FGR(\n  Hist(time_c, outcome_comp) ~ \n    post_olt_compli1 + post_olt_compli3 + post_olt_compli5 +\n    multisite_col + cre_col1 + cre_col2,\n  data  = df_model,\n  cause = 1\n)\n\n# ============================================================\n# 3. Predictions vs Observed CIF\n# ============================================================\ntimes_seq <- seq(0, 180, by = 5)\n\npred_cif <- predict(\n  fg_risk,\n  newdata = df_model,\n  cause = 1,\n  times = times_seq,\n  se = FALSE,\n  keep.newdata = FALSE\n)\n\npred_df <- data.frame(\n  times = times_seq,\n  CIF_pred = colMeans(pred_cif, na.rm = TRUE)\n)\n\nci_fit <- prodlim(Hist(time_c, outcome_comp) ~ 1, data = df_model)\nobs_df <- data.frame(\n  times = times_seq,\n  CIF_obs = predict(ci_fit, cause = 1, times = times_seq)\n)\n\nplot_df <- left_join(obs_df, pred_df, by = \"times\")\n\n# ============================================================\n# 4. Dot dataset with event type\n# ============================================================\ndot_df <- df_model %>%\n  mutate(\n    dot_type = case_when(\n      outcome_comp == 1 ~ \"CRE infection\",\n      outcome_comp == 2 ~ \"Discharge\",\n      outcome_comp == 3 ~ \"Death\",\n      outcome_comp == 0 ~ \"Censored\"\n    ),\n    # assign strip positions\n    y_pos = case_when(\n      outcome_comp == 1 ~ -0.01,   # infections (bottom)\n      outcome_comp == 2 ~ 0.26,    # discharge\n      outcome_comp == 3 ~ 0.27,    # death\n      outcome_comp == 0 ~ 0.28     # censored\n    )\n  ) %>%\n  filter(!is.na(dot_type))\n\n# ============================================================\n# 5. NEJM-style plot with jittered dots + legend\n# ============================================================\nnejm_colors <- c(\"Observed\" = \"black\",\n                 \"Predicted\" = \"#D81B60\")\n\ndot_colors <- c(\"CRE infection\" = \"red\",\n                \"Discharge\"    = \"green3\",\n                \"Death\"        = \"black\",\n                \"Censored\"     = \"grey50\")\n\np_calib <- ggplot(plot_df, aes(x = times)) +\n  # Calibration curves\n  geom_line(aes(y = CIF_obs, color = \"Observed\"), size = 1.2) +\n  geom_line(aes(y = CIF_pred, color = \"Predicted\"),\n            size = 1.2, linetype = \"dashed\") +\n  # Jittered dots with legend\n  geom_jitter(\n    data = dot_df,\n    aes(x = time_c, y = y_pos, color = dot_type),\n    inherit.aes = FALSE,\n    width = 0, height = 0.002,\n    shape = 16, alpha = 0.6, size = 1.5\n  ) +\n  labs(x = \"Days since OLT\",\n       y = \"Cumulative incidence of CRE infection\",\n       title = \"Observed vs Predicted CIF with Patient Distributions\") +\n  scale_color_manual(values = c(nejm_colors, dot_colors)) +\n  coord_cartesian(ylim = c(0, max(plot_df$CIF_obs, plot_df$CIF_pred, na.rm = TRUE) * 1.1)) +\n  theme_bw(base_size = 14) +\n  theme(\n    panel.grid = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    legend.text = element_text(size = 11),\n    axis.title = element_text(size = 14, face = \"bold\"),\n    axis.text = element_text(size = 12),\n    axis.ticks.length = unit(0.2, \"cm\")\n  )\n\nprint(p_calib)\n```\n\n::: {.cell-output-display}\n![](validation_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nCalibration plot of CRECOOLT risk model in total combined population\n:::\n\nThe calibration of the CRECOOLT prediction model stratified by retrospective versus prospectively enrolled patients in shown in [@fig-calibration2].\n\n::: {#fig-calibration2}\n\n::: {.cell}\n\n```{.r .cell-code}\n#############################################\n## Stratified calibration with separated outcome dots\n#############################################\n\nlibrary(dplyr)\nlibrary(riskRegression)\nlibrary(prodlim)\nlibrary(ggplot2)\n\n## 1) Prep with study design\ndf_model <- data_extract %>%\n  mutate(\n    post_olt_compli1 = as.integer(post_olt_compli___1 == 1),\n    post_olt_compli3 = as.integer(post_olt_compli___3 == 1),\n    post_olt_compli5 = as.integer(post_olt_compli___5 == 1),\n    multisite_col    = as.integer(multisite_colonization == 1),\n    cre_col1         = as.integer(cre_colonization___1 == 1),\n    cre_col2         = as.integer(cre_colonization___2 == 1),\n    retro_group      = factor(ifelse(retro_or_pros == 1, \"Retrospective\", \"Prospective\"))\n  ) %>%\n  select(time_c, outcome_comp, retro_group,\n         post_olt_compli1, post_olt_compli3, post_olt_compli5,\n         multisite_col, cre_col1, cre_col2) %>%\n  filter(!is.na(time_c) & time_c >= 0 & !is.na(retro_group))\n\n## 2) Fit FG once on full data\nfg_risk <- FGR(\n  Hist(time_c, outcome_comp) ~ \n    post_olt_compli1 + post_olt_compli3 + post_olt_compli5 +\n    multisite_col + cre_col1 + cre_col2,\n  data  = df_model,\n  cause = 1\n)\n\n## 3) Time grid\ntimes_seq <- seq(0, 180, by = 5)\n\n## 4) Helper to get obs + pred per subgroup\nget_obs_pred <- function(dat, group_label){\n  if (nrow(dat) < 2) return(NULL)\n  ci_fit <- prodlim(Hist(time_c, outcome_comp) ~ 1, data = dat)\n  obs_df <- data.frame(\n    times   = times_seq,\n    CIF_obs = predict(ci_fit, cause = 1, times = times_seq)\n  )\n  pred_cif <- predict(\n    fg_risk, newdata = dat, cause = 1, times = times_seq,\n    se = FALSE, keep.newdata = FALSE\n  )\n  pred_df <- data.frame(\n    times    = times_seq,\n    CIF_pred = colMeans(pred_cif, na.rm = TRUE)\n  )\n  dplyr::left_join(obs_df, pred_df, by = \"times\") %>%\n    mutate(group = group_label)\n}\n\n## 5) Build calibration data for facets\nplot_df <- bind_rows(\n  get_obs_pred(filter(df_model, retro_group == \"Retrospective\"), \"Retrospective\"),\n  get_obs_pred(filter(df_model, retro_group == \"Prospective\"),  \"Prospective\")\n)\n\n## --- Dynamic strip positions so dots never get clipped ----\ny_max <- max(plot_df$CIF_obs, plot_df$CIF_pred, na.rm = TRUE)\ny_bottom  <- -0.03 * y_max                  # CRE dots (bottom)\ny_top_base <-  1.02 * y_max                 # base just above curves\ny_discharge <- y_top_base + 0.01 * y_max\ny_death     <- y_top_base + 0.03 * y_max\ny_censored  <- y_top_base + 0.05 * y_max\ny_min_plot  <- y_bottom - 0.01 * y_max\ny_max_plot  <- y_top_base + 0.07 * y_max\n\n## 6) Dot data (with facet variable)\ndot_df <- df_model %>%\n  mutate(\n    group   = retro_group,  # match facet variable\n    dot_type = case_when(\n      outcome_comp == 1 ~ \"CRE infection\",\n      outcome_comp == 2 ~ \"Discharge\",\n      outcome_comp == 3 ~ \"Death\",\n      outcome_comp == 0 ~ \"Censored\",\n      TRUE ~ NA_character_\n    ),\n    y_pos = case_when(\n      outcome_comp == 1 ~ y_bottom,\n      outcome_comp == 2 ~ y_discharge,\n      outcome_comp == 3 ~ y_death,\n      outcome_comp == 0 ~ y_censored,\n      TRUE ~ NA_real_\n    )\n  ) %>%\n  filter(!is.na(dot_type))\n\n## 7) Plot\nnejm_colors <- c(\"Observed\" = \"black\",\n                 \"Predicted\" = \"#D81B60\")\n\ndot_colors <- c(\"CRE infection\" = \"red\",\n                \"Discharge\"    = \"green3\",\n                \"Death\"        = \"black\",\n                \"Censored\"     = \"grey50\")\n\np_calib_strat <- ggplot(plot_df, aes(x = times)) +\n  # curves\n  geom_line(aes(y = CIF_obs, color = \"Observed\"), size = 1.2) +\n  geom_line(aes(y = CIF_pred, color = \"Predicted\"),\n            size = 1.2, linetype = \"dashed\") +\n  # dots (with facet-aware data)\n  geom_jitter(\n    data = dot_df,\n    aes(x = time_c, y = y_pos, color = dot_type),\n    inherit.aes = FALSE,\n    width = 0, height = 0.002,\n    shape = 16,\n    alpha = 0.7,\n    size = ifelse(dot_df$dot_type == \"Death\", 1.9, 1.4)  # make deaths a touch larger\n  ) +\n  facet_wrap(~group) +\n  labs(x = \"Days since OLT\",\n       y = \"Cumulative incidence of CRE infection\",\n       title = \"Observed vs Predicted CIF by Study Design\") +\n  scale_color_manual(values = c(nejm_colors, dot_colors)) +\n  coord_cartesian(ylim = c(y_min_plot, y_max_plot)) +\n  theme_bw(base_size = 14) +\n  theme(\n    panel.grid = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    legend.text  = element_text(size = 11),\n    axis.title   = element_text(size = 14, face = \"bold\"),\n    axis.text    = element_text(size = 12),\n    axis.ticks.length = unit(0.2, \"cm\")\n  )\n\nprint(p_calib_strat)\n```\n\n::: {.cell-output-display}\n![](validation_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nCalibration plot of CRECOOLT risk model stratified by prospectively vs. retrospectively enrolled patients\n:::\n\nThe distribution of model covariates differed somewhat in the retrospective versus prospective groups as shown in [@fig-dist1].\n\n::: {#fig-dist1}\n\n::: {.cell}\n\n```{.r .cell-code}\n#############################################\n## Bar plot of covariate distribution\n## Retrospective vs Prospective cohorts\n## with custom labels\n#############################################\n\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\n\n# ============================================================\n# 1. Select the covariates of interest\n# ============================================================\ncovariates <- c(\"post_olt_compli1\", \"post_olt_compli3\", \"post_olt_compli5\",\n                \"multisite_col\", \"cre_col1\", \"cre_col2\")\n\ndf_cov <- df_model %>%\n  select(retro_group, all_of(covariates))\n\n# ============================================================\n# 2. Reshape to long format\n# ============================================================\ndf_long <- df_cov %>%\n  pivot_longer(\n    cols = all_of(covariates),\n    names_to = \"covariate\",\n    values_to = \"value\"\n  )\n\n# ============================================================\n# 3. Summarize % positive per group\n# ============================================================\ndf_summary <- df_long %>%\n  group_by(retro_group, covariate) %>%\n  summarise(\n    n = n(),\n    n_pos = sum(value == 1, na.rm = TRUE),\n    pct_pos = 100 * n_pos / n,\n    .groups = \"drop\"\n  ) %>%\n  mutate(\n    covariate_label = recode(covariate,\n                             \"cre_col1\"          = \"Prior\",\n                             \"cre_col2\"          = \"Post\",\n                             \"mec1\"              = \"KPC\",\n                             \"multisite_col\"     = \"Multisite\",\n                             \"post_olt_compli1\"  = \"ARF\",\n                             \"post_olt_compli3\"  = \"Vent\",\n                             \"post_olt_compli5\"  = \"Reint\"\n    )\n  )\n\n# ============================================================\n# 4. Bar plot (NEJM-style)\n# ============================================================\np_cov <- ggplot(df_summary, aes(x = covariate_label, y = pct_pos, fill = retro_group)) +\n  geom_col(position = position_dodge(width = 0.8), width = 0.7) +\n  labs(x = \"Covariate\", y = \"Percent positive (%)\",\n       title = \"Distribution of Covariates by Study Design\") +\n  scale_fill_manual(values = c(\"Retrospective\" = \"#1E88E5\", \"Prospective\" = \"#D81B60\")) +\n  theme_bw(base_size = 14) +\n  theme(\n    axis.text.x = element_text(angle = 30, hjust = 1, size = 11),\n    axis.title = element_text(size = 14, face = \"bold\"),\n    panel.grid.major.x = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank()\n  )\n\nprint(p_cov)\n```\n\n::: {.cell-output-display}\n![](validation_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nDistribution of CRECOOLT model covariates in the prospective vs. retrospective cohorts\n:::\n\nThis distribution can be contrasted with the initial variable distributions from the CRECOOLT 2.0 study [@giannella2021] as shown in @fig-dist2.\n\n::: {#fig-dist2}\n\n::: {.cell}\n\n```{.r .cell-code}\n#############################################\n## Bar plot of covariate distribution\n## Previous study (CRE3 dataset)\n#############################################\n\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\n\n# ============================================================\n# 1. Load and clean CRE3 dataset\n# ============================================================\nCRE3 <- read.csv(\"CRE3.csv\", stringsAsFactors = FALSE)\n\nCRE3_clean <- CRE3 %>%\n  mutate(\n    time        = as.numeric(time),\n    status      = as.numeric(status),\n    reint       = as.numeric(reint),\n    mv          = as.numeric(mv),\n    arf         = as.numeric(arf),\n    crepre_60   = as.numeric(crepre_60),\n    crepost_60  = as.numeric(crepost_60),\n    multipost   = as.numeric(multipost)\n  ) %>%\n  filter(!is.na(time), !is.na(status), time > 0)\n\n# ============================================================\n# 2. Select predictors and reshape to long format\n# ============================================================\npredictors <- c(\"reint\", \"mv\", \"arf\", \"crepre_60\", \"crepost_60\", \"multipost\")\n\ndf_long <- CRE3_clean %>%\n  select(all_of(predictors)) %>%\n  pivot_longer(\n    cols = all_of(predictors),\n    names_to = \"covariate\",\n    values_to = \"value\"\n  )\n\n# ============================================================\n# 3. Summarize % positive for each covariate\n# ============================================================\ndf_summary <- df_long %>%\n  group_by(covariate) %>%\n  summarise(\n    n = n(),\n    n_pos = sum(value == 1, na.rm = TRUE),\n    pct_pos = 100 * n_pos / n,\n    .groups = \"drop\"\n  ) %>%\n  mutate(\n    covariate_label = recode(covariate,\n      \"reint\"       = \"Reint\",\n      \"mv\"          = \"Vent\",\n      \"arf\"         = \"ARF\",\n      \"crepre_60\"   = \"Coln prior\",\n      \"crepost_60\"  = \"Coln post\",\n      \"multipost\"   = \"Multisite\"\n    )\n  )\n\n# ============================================================\n# 4. Bar plot (NEJM-style)\n# ============================================================\np_cov_CRE3 <- ggplot(df_summary, aes(x = covariate_label, y = pct_pos)) +\n  geom_col(fill = \"#1E88E5\", width = 0.7) +\n  labs(x = \"Covariate\", y = \"Percent positive (%)\",\n       title = \"Covariate Distribution (Previous Study, CRE3)\") +\n  theme_bw(base_size = 14) +\n  theme(\n    axis.text.x = element_text(angle = 30, hjust = 1, size = 11),\n    axis.title = element_text(size = 14, face = \"bold\"),\n    panel.grid.major.x = element_blank()\n  )\n\nprint(p_cov_CRE3)\n```\n\n::: {.cell-output-display}\n![](validation_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nDistribution of covariates in the original CRECOOLT 2.0 model\n:::\n\n::: callout-important\n## Interesting observation\n\nThere is a marked difference in the pre OLT versus post OLT CRE colonization rates between the previous CRECOOLT cohort and the current study. Most of the patients in the previous study had CRE colonization *after* OLT whereas in the current cohorts CRE colonization occurred *before* OLT. Yet the model still seemed to predict the risk of CRE infection well.\n:::\n",
    "supporting": [
      "validation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}